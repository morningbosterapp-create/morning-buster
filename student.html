<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Booster | Student Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; background: #050508; color: white; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); border-radius: 30px; }
        .btn-gradient { background: linear-gradient(135deg, #7000ff, #ff007a); transition: 0.4s; }
        .btn-gradient:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(112, 0, 255, 0.4); }
        .hidden { display: none; }
        input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 12px; color: white; outline: none; }
    </style>
</head>
<body class="p-4 md:p-6">

    <div id="login-screen" class="min-h-screen flex items-center justify-center animate-in fade-in duration-700">
        <div class="glass p-10 w-full max-w-md text-center space-y-6">
            <h1 class="text-3xl font-black italic tracking-tighter italic">BOOSTER <span class="text-purple-500">PRO</span></h1>
            <p class="text-xs text-gray-400 uppercase tracking-widest">Enter your credentials to study</p>
            <div class="flex flex-col gap-4 text-left">
                <label class="text-[10px] font-bold uppercase ml-2">Student ID</label>
                <input type="text" id="student-id" placeholder="Ex: MB-1024">
                <label class="text-[10px] font-bold uppercase ml-2">Month Key (Active Month)</label>
                <input type="password" id="month-key" placeholder="••••••••">
            </div>
            <button onclick="handleLogin()" class="btn-gradient w-full py-4 rounded-2xl font-black tracking-widest">LOGIN NOW</button>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-2xl mx-auto space-y-6 pb-24 animate-in slide-in-from-bottom-10 duration-700">
        
        <header class="glass p-6 flex items-center gap-6">
            <div class="w-20 h-20 rounded-2xl border-2 border-purple-500 overflow-hidden">
                <img src="1.p" alt="Teacher" class="w-full h-full object-cover">
            </div>
            <div>
                <h2 id="greeting" class="text-xs font-bold text-gray-400 uppercase tracking-widest">Good Morning,</h2>
                <h1 class="text-2xl font-black tracking-tighter italic" id="display-name">STUDENT</h1>
                <p class="text-[10px] bg-purple-500/20 text-purple-400 px-2 py-1 rounded-full inline-block mt-2">Theory: Unit 05 - Kinetic</p>
            </div>
        </header>

        <div id="status-card" class="glass p-8 text-center space-y-4 border-t-4 border-purple-500">
            <i data-lucide="zap" class="w-12 h-12 text-yellow-500 mx-auto"></i>
            <h3 class="text-xl font-bold">Today's Booster is Ready!</h3>
            <p class="text-gray-400 text-sm">ප්‍රශ්න 3යි, විනාඩි 5යි. ඔබ සූදානම්ද?</p>
            <button onclick="startBooster()" class="btn-gradient px-10 py-4 rounded-full font-black">START TODAY BOOSTER</button>
        </div>

        <div id="done-card" class="glass p-8 text-center space-y-4 border-t-4 border-green-500 hidden">
            <i data-lucide="check-circle" class="w-12 h-12 text-green-500 mx-auto"></i>
            <h3 class="text-xl font-bold">Already Done for Today!</h3>
            <p class="text-gray-400 text-sm">හෙට නැවත හමුවෙමු. ඔබේ රිකවරි බලන්න.</p>
        </div>

        <div class="glass p-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Your Performance</h3>
            <div class="h-32 flex items-end gap-2 px-4">
                <div class="bg-purple-600/40 w-full h-[30%] rounded-t-lg"></div>
                <div class="bg-purple-600/60 w-full h-[60%] rounded-t-lg"></div>
                <div class="bg-purple-600 w-full h-[85%] rounded-t-lg"></div>
                <div class="bg-purple-500 w-full h-[40%] rounded-t-lg"></div>
            </div>
            <div class="flex justify-between mt-4 text-[10px] font-bold text-gray-500">
                <span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span><span>SUN</span>
            </div>
        </div>

        <div class="glass p-6 space-y-4">
            <h3 class="text-xs font-bold text-pink-500 uppercase tracking-widest flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Recovery (Space Repetition)
            </h3>
            <div id="recovery-items" class="space-y-3">
                <p class="text-xs text-gray-500 italic">අදට රිකවරි කිරීමට කිසිවක් නැත.</p>
            </div>
        </div>
    </div>

    <div id="booster-ui" class="hidden fixed inset-0 bg-[#050508] z-50 p-6">
        <div class="max-w-xl mx-auto h-full flex flex-col justify-center space-y-8">
            <div id="q-step" class="space-y-6 animate-in slide-in-from-right-10 duration-500">
                <span id="q-num" class="text-purple-500 font-black text-4xl">01</span>
                <div id="q-img-box" class="hidden w-full h-48 rounded-2xl overflow-hidden border border-white/10 mb-4">
                    <img id="q-img" src="" class="w-full h-full object-cover">
                </div>
                <h2 id="q-text" class="text-2xl font-bold leading-tight">Loading Question...</h2>
                <div id="options" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1Kt-b-bb6HhY0k_Yb72MrKZukC0hdm0k",
            authDomain: "morning-boster.firebaseapp.com",
            databaseURL: "https://morning-boster-default-rtdb.firebaseio.com",
            projectId: "morning-boster",
            storageBucket: "morning-boster.firebasestorage.app",
            messagingSenderId: "465023464210",
            appId: "1:465023464210:web:1d53b1bd6185f2603fb9cb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const today = new Date().toISOString().split('T')[0];

        let studentData = null;
        let currentBooster = null;
        let answers = [];
        let currentQIdx = 0;

        // --- Logic: Authentication ---
        window.handleLogin = async () => {
            const id = document.getElementById('student-id').value;
            const key = document.getElementById('month-key').value;
            
            if(id && key === "2024DEC") { // Example key logic
                localStorage.setItem('studentId', id);
                loadDashboard(id);
            } else {
                alert("වැරදි Student ID හෝ Month Key එකක්!");
            }
        };

        // --- Logic: Dashboard ---
        async function loadDashboard(id) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('display-name').innerText = id;
            
            const hr = new Date().getHours();
            document.getElementById('greeting').innerText = hr < 12 ? "Good Morning," : hr < 18 ? "Good Afternoon," : "Good Evening,";

            // Load Today's Data
            const snapshot = await get(ref(db, 'booster/' + today));
            if(snapshot.exists()) {
                currentBooster = snapshot.val();
                checkIfDone(id);
            }
            loadRecovery(id);
            lucide.createIcons();
        }

        async function checkIfDone(id) {
            const snap = await get(ref(db, `results/${id}/${today}`));
            if(snap.exists()) {
                document.getElementById('status-card').classList.add('hidden');
                document.getElementById('done-card').classList.remove('hidden');
            }
        }

        // --- Logic: Booster ---
        window.startBooster = () => {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('booster-ui').classList.remove('hidden');
            showQuestion();
        };

        function showQuestion() {
            const qKey = `q${currentQIdx + 1}`;
            const qData = currentBooster.questions[qKey];
            
            document.getElementById('q-num').innerText = `0${currentQIdx + 1}`;
            document.getElementById('q-text').innerText = qData.text;
            
            if(qData.img) {
                document.getElementById('q-img-box').classList.remove('hidden');
                document.getElementById('q-img').src = qData.img;
            } else {
                document.getElementById('q-img-box').classList.add('hidden');
            }

            const optBox = document.getElementById('options');
            optBox.innerHTML = '';
            qData.ans.forEach((a, i) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 glass hover:bg-white/10 transition border border-white/5 rounded-2xl text-sm";
                btn.innerText = a;
                btn.onclick = () => handleAnswer(i + 1);
                optBox.appendChild(btn);
            });
        }

        function handleAnswer(ans) {
            const qKey = `q${currentQIdx + 1}`;
            const isCorrect = ans == currentBooster.questions[qKey].correct;
            answers.push(isCorrect);

            if(currentQIdx < 2) {
                currentQIdx++;
                showQuestion();
            } else {
                finishBooster();
            }
        }

        async function finishBooster() {
            const id = localStorage.getItem('studentId');
            // Pattern Calculation for ANL 1
            // 1=Correct, 0=Wrong. Ex: [true, false, false] -> pattern index 0
            const patternIdx = calculatePatternIndex(answers);
            const videoUrl = currentBooster.patterns[patternIdx];

            // Space Repetition Logic for Flashcards
            answers.forEach((isCorrect, idx) => {
                if(!isCorrect) {
                    const flash = currentBooster.flashCards[idx];
                    addToRecovery(id, flash);
                }
            });

            await set(ref(db, `results/${id}/${today}`), {
                answers: answers,
                timestamp: Date.now()
            });

            alert("අද booster එක අවසන්! ඔබට අදාළ වීඩියෝව දැන් පෙන්වනු ඇත.");
            window.location.href = videoUrl;
        }

        function calculatePatternIndex(ans) {
            // Mapping patterns like "(1) හරි, (2) වැරදි, (3) වැරදි" etc to 0-7 index
            if(ans[0] && !ans[1] && !ans[2]) return 0;
            if(!ans[0] && ans[1] && !ans[2]) return 1;
            if(!ans[0] && !ans[1] && ans[2]) return 2;
            if(ans[0] && ans[1] && !ans[2]) return 3;
            if(ans[0] && !ans[1] && ans[2]) return 4;
            if(!ans[0] && ans[1] && ans[2]) return 5;
            if(ans[0] && ans[1] && ans[2]) return 6;
            return 7;
        }

        function addToRecovery(id, flash) {
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + 1); // Step 1: 1 day later
            const key = nextDate.toISOString().split('T')[0];
            set(ref(db, `recovery/${id}/${key}/${Date.now()}`), flash);
        }

        async function loadRecovery(id) {
            const snap = await get(ref(db, `recovery/${id}/${today}`));
            if(snap.exists()) {
                const container = document.getElementById('recovery-items');
                container.innerHTML = '';
                Object.values(snap.val()).forEach(card => {
                    container.innerHTML += `
                        <div class="p-4 bg-white/5 border border-pink-500/20 rounded-2xl flex justify-between items-center">
                            <span class="text-xs">${card.front}</span>
                            <button onclick="alert('${card.back}')" class="text-[10px] bg-pink-500/20 text-pink-500 px-3 py-1 rounded-lg font-bold">VIEW ANSWER</button>
                        </div>
                    `;
                });
            }
        }

        // Auto Login if ID exists
        const savedId = localStorage.getItem('studentId');
        if(savedId) loadDashboard(savedId);

    </script>
</body>
</html>
